```{r setup}
#| include: false 
library(tidyverse) 
cols <- c("obs" = "#3f3f3f", "sim" = "#0da1f8", "sat" = "#fb7754")
```

# Evaluation 2

Evaluation of the TROLL version 4 simulations of daily fluxes and the final structure and composition of the forest in relation to field observations and remote sensing at two Amazonian sites.

## Allometries

```{r}
data.frame(dbh = seq(1, 100, 1)) %>% 
  mutate(allometry = list(data.frame(a = c(2.13, 2), 
                                     b = c(0.63, 0.59), 
                                     sigma = c(0.29, 0.35),
                                     type = c("base", "calib")))) %>% 
  unnest(allometry) %>% 
  mutate(cr = exp(a+b*log(dbh)),
         cr_l = exp(a+b*log(dbh)+sigma),
         cr_h = exp(a+b*log(dbh)-sigma)) %>% 
  ggplot(aes(dbh, cr, col = type)) +
  geom_ribbon(aes(ymin = cr_l, ymax = cr_h, fill = type), col = NA, alpha = 0.2) +
  geom_line() +
  theme_bw()
```

## Fluxes

```{r fluxes}
#| eval: false
trollwater <- list(
  Tapajos_base = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_water_balance.txt") %>% 
     mutate(date = as_date("2002/01/01")+iter),
  Tapajos_calib = read_tsv("results2/run3/Tapajos_R1/Tapajos_R1_0_water_balance.txt") %>% 
     mutate(date = as_date("2002/01/01")+iter)
) %>% bind_rows(.id = "site") %>% 
  mutate(swc0 = SWC_0, swc1 = SWC_1, swc2 = SWC_2,  swc3 = SWC_3,  swc4 = SWC_4,
         et = (transpitation_0 + transpitation_1 + transpitation_2 + 
                 transpitation_3 + transpitation_4 + evaporation + 
                 (precipitation/1000-throughfall))*1000) %>% 
  select(site, date, swc0, swc1, swc2, swc3, swc4, et) %>% 
  group_by(site, year = year(date)) %>% 
  mutate(rswc10 = swc0/quantile(swc0, 0.95, na.rm = T)) %>% 
  ungroup() %>% 
  select(-year) %>% 
  gather(variable, simulated, -site, -date)
trollsum <- list(
  Tapajos_base = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_sumstats.txt") %>% 
     mutate(date = as_date("2002/01/01")+iter),
  Tapajos_calib = read_tsv("results2/run3/Tapajos_R1/Tapajos_R1_0_sumstats.txt") %>% 
     mutate(date = as_date("2002/01/01")+iter)
) %>% bind_rows(.id = "site") %>% 
  select(-npp, -rday, -rnight, -rstem) %>% 
  mutate(litter = litterfall*10^2, gpp = gpp*10^2*365/10^3) %>% 
  select(-iter, -litterfall) %>% 
  gather(variable, simulated, -site, -date)
lai <- list(
  Tapajos_base = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAIdynamics.txt") %>% 
     mutate(date = as_date("2002/01/01")+iter),
  Tapajos_calib = read_tsv("results2/run3/Tapajos_R1/Tapajos_R1_0_LAIdynamics.txt") %>% 
     mutate(date = as_date("2002/01/01")+iter)
) %>% bind_rows(.id = "site") %>% 
  mutate(variable = "lai", simulated = LAI) %>% 
  select(site, date, variable, simulated)
lai_age <- list(
  Tapajos_base = list(
    lai_young = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAIyoung.txt"),
    lai_mature = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAImature.txt") %>% 
      mutate(iter = as.numeric(iter)) %>% na.omit(),
    lai_old = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAIold.txt") %>% 
      mutate(iter = as.numeric(iter)) %>% na.omit()
  ) %>% bind_rows(.id = "variable"),
  Tapajos_calib = list(
    lai_young = read_tsv("results2/run3/Tapajos_R1/Tapajos_R1_0_LAIyoung.txt"),
    lai_mature = read_tsv("results2/run3/Tapajos_R1/Tapajos_R1_0_LAImature.txt") %>% 
      mutate(iter = as.numeric(iter)) %>% na.omit(),
    lai_old = read_tsv("results2/run3/Tapajos_R1/Tapajos_R1_0_LAIold.txt") %>% 
      mutate(iter = as.numeric(iter)) %>% na.omit()
  ) %>% bind_rows(.id = "variable")
) %>% bind_rows(.id = "site") %>% 
  mutate(date = as_date("2004/01/01")+iter) %>% 
  select(-iter) %>% 
  gather(height, value, -date, -variable, -site) %>% 
  group_by(site, variable, date) %>% 
  summarise(simulated = sum(value))
bind_rows(trollwater, trollsum, lai, lai_age) %>% 
  write_tsv("outputs/evaluation_fluxes2.tsv")
```

### Growth Primary Productivity

```{r gppdata}
#| message: false
daily <- read_tsv("outputs/evaluation_fluxes2.tsv") %>% 
  filter(variable == "gpp") %>% 
  mutate(site2 = site, site = "Tapajos") %>% 
  left_join(read_tsv("outputs/fluxnet_fluxes.tsv") %>% 
              mutate(observed = value*10^2*365/10^3) %>% 
              select(-value)) %>% 
  left_join(read_tsv("outputs/fluxnet_fluxes.tsv") %>% 
              filter(variable %in% c("par", "vpd_max", "temperature", "ws")) %>% 
              rename(determinant = variable, determinant_value = value)) %>% 
  left_join(read_tsv("data/fluxes/rtsif.tsv") %>% 
              mutate(satellite = rtsif*15.343*365/10^3) %>% 
              select(-rtsif)) %>% 
  mutate(site = site2) %>% 
  select(-site2) %>% 
  gather(type, value, -site, -date, -variable, -determinant, -determinant_value)
monthly <- daily %>% 
  group_by(site, date = floor_date(date, "month"), variable, type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            value = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE))
```

```{r gppdaily}
#| message: false
#| warning: false
#| fig-cap: "Daily and monthly means of growth primary productivity for Paracou and Tapajos. Dark lines are the monthly means, semi-transparent lines are the daily means variations with the exception of satellite data for which data are available only every 8 days."
daily %>% 
  ggplot(aes(date, value, col = type)) +
  geom_line(alpha = 0.5) +
  geom_line(data = monthly) +
  facet_wrap(~ site, nrow = 2) +
  theme_bw() +
  theme(legend.position = "bottom") +
  xlab("") +
  ylab(expression("Growth Primary Productivity ["~kgC~m^{-2}~yr^{-1}~"]")) +
  scale_color_manual("", values = as.vector(cols[c("obs", "sat", "sim")]), 
                     labels = c("Tower", "Satellite", "TROLL"))
```

```{r gpp15days}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of growth primary productivity for Paracou and Tapajos. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
daily %>% 
  group_by(site, variable, type, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date)) %>%  
  group_by(site, variable, type, week) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  ggplot(aes(week, m)) +
  geom_ribbon(aes(ymin = l, ymax = h, fill = type), col = NA, alpha = 0.2) +
  geom_smooth(aes(col = type), se = FALSE) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_discrete("") +
  scale_color_discrete("") +
  facet_wrap(~ site, scales = "free_x") +
    scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) +
  ylab(expression("Growth Primary Productivity ["~kgC~m^{-~2}~yr^{-~1}~"]")) +
  xlab("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sat", "sim")]), 
                     labels = c("Tower", "Satellite", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("obs", "sat", "sim")]), 
                     labels = c("Tower", "Satellite", "TROLL"))
```

```{r gppdet}
#| message: false
#| warning: false
#| fig-cap: "Daily averages of growth primary productivity as a function of vapour pressure deficit, incoming photosynthetically active radiation, temperature, and wind speed for model-, satellite- and tower-based estimates at Paracou and Tapajos."
daily %>% 
  mutate(determinant_value = ifelse(determinant == "par", 
                                    determinant_value/10^2, determinant_value)) %>% 
  mutate(det_long = recode(determinant, 
                           "par" = 'Incoming~PAR~"["~mol~m^{-~2}~day^{-~1}~"]"',
                           "temperature" = 'Temperature~"["~degree~C~"]"',
                            "vpd_max" = '"Vapour Pressure Deficit ["~kPa~day^{-~1}~"]"',
                           "ws" = 'Wind~Speed~"["~m^{2}~s^{-~1}~"]"')) %>% 
  ggplot(aes(determinant_value, value, col = type)) +
  geom_point(alpha = 0.1) +
  theme_bw() +
  facet_grid(site ~ det_long, scales = "free", labeller = label_parsed) +
  theme(legend.position = "bottom") +
  geom_smooth(method = "lm", formula = "y ~ 1+log(x+10^-6)", se = FALSE) +
  ylab(expression("Growth Primary Productivity ["~kgC~m^{-~2}~yr^{-~1}~"]")) +
  xlab("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sat", "sim")]), 
                     labels = c("Tower", "Satellite", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("obs", "sat", "sim")]), 
                     labels = c("Tower", "Satellite", "TROLL")) +
  ylim(0, 7.5) +
  ggpubr::stat_cor()
```

```{r gppevalplot}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of simulated versus observed daily means of GPP in Paracou and Tapajos."
daily %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  gather(type, observed, -site, -date, -variable, -determinant, -determinant_value, -simulated) %>% 
  ggplot(aes(simulated,observed, col = yday(date))) +
  facet_grid(site ~ type) +
  theme_bw() +
  geom_point() +
  scale_color_viridis_c("Day") +
  geom_abline(col = "red") +
  xlab(expression("Observed GPP ["~kgC~m^{-~2}~yr^{-~1}~"]")) +
  ylab(expression("Simulated GPP ["~kgC~m^{-~2}~yr^{-~1}~"]")) +
  scale_color_viridis_c("Day") +
  ggpubr::stat_cor()
```

```{r evaltab}
daily %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  gather(type, observed, -site, -date, -variable, -determinant, -determinant_value, -simulated) %>% 
  na.omit() %>% 
  nest_by(site, variable, type) %>% 
  mutate(R2 = summary(lm(observed ~ 0 + simulated, data = data))$r.squared,
         CC = cor(data$simulated, data$observed),
         RMSEP = sqrt(mean((data$simulated-data$observed)^2)),
         RRMSEP = sqrt(mean((data$simulated-data$observed)^2))/mean(data$observed),
         SD =sd(data$simulated-data$observed),
         RSD =sd(data$simulated-data$observed)/mean(data$observed)) %>% 
  select(-data) %>% 
  knitr::kable(caption = "Evaluation fo daily means of GPP at Paracou and Tapajos.")
```

### Leaf Area Index

```{r laidata}
#| message: false
daily <- read_tsv("outputs/evaluation_fluxes2.tsv") %>% 
  filter(variable == "lai") %>% 
  mutate(site2 = site, site = "Tapajos") %>% 
  select(-variable) %>% 
  mutate(type = "simulated") %>% 
  rename(value = simulated) %>% 
  bind_rows(read_tsv("outputs/lai.tsv") %>% 
              rename(type = variable)) %>% 
  bind_rows(readxl::read_xlsx("data/fluxes/Data_LAI_new.xlsx") %>% 
              mutate(date = as_date(paste0("2010-", month, "-15"))) %>% 
              mutate(site = "Tapajos", type = "PhenoCam", value = `Camera_LAI (m^2 m^-2)`) %>% 
              select(date, value, site, type)) %>% 
    mutate(type = recode(type, 
                       "LAD" = "LAI (Smith et al., 2019)",
                       "LAI" = "LAI Modis",
                       "PAD" = "PAI (Barbier, Verley, Vincent, unpublished)",
                       "PhenoCam" = "PhenoCam (Wu et al. 2016)",
                       "simulated" = "TROLL")) %>% 
    mutate(site = site2) %>% 
  select(-site2)
monthly <- daily %>% 
  group_by(site, date = floor_date(date, "month"), type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            value = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE))
```

```{r laidaily}
#| message: false
#| warning: false
#| fig-cap: "Daily and monthly means of leaf area index for Paracou and Tapajos. Dark lines are the monthly means, semi-transparent lines are the daily means variations with the exception of satellite data for which data are available only every 8 days."
daily %>% 
  ggplot(aes(date, value, col = type)) +
  geom_line(alpha = 0.5) +
  geom_line(data = monthly) +
  facet_wrap(~ site, scales = "free_x") +
  theme_bw() +
  theme(legend.position = "bottom") +
  xlab("") + 
  ylab(expression("Leaf Area Index ["~m^2~m^{-2}~"]")) +
  scale_color_discrete("") +
  guides(col = guide_legend(nrow = 2))
```

```{r lai15days}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of leaf area index for Paracou and Tapajos. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
daily %>% 
  group_by(site, type, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date)) %>%  
  group_by(site, type, week) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  ggplot(aes(week, m)) +
  geom_ribbon(aes(ymin = l, ymax = h, fill = type), col = NA, alpha = 0.2) +
  geom_smooth(aes(col = type), se = FALSE) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_manual("", values = c("#ffa006", "#fb7754", "#197b14", "#3f3f3f",  "#0da1f8")) +
  scale_color_manual("", values = c("#ffa006", "#fb7754", "#197b14", "#3f3f3f",  "#0da1f8")) +
  facet_wrap(~ site, scales = "free_x") +
    scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) +
  ylab(expression("Leaf Area Index ["~m^2~m^{-~2}~"]")) + xlab("") +
  guides(col = guide_legend(nrow = 2), fill = guide_legend(nrow = 2))
```

### Leaf Area Index per Age

```{r laiadata}
#| message: false
daily <- read_tsv("outputs/evaluation_fluxes2.tsv") %>% 
  filter(variable %in% c("lai_mature", "lai_old", "lai_young")) %>% 
  mutate(site2 = site, site = "Tapajos") %>% 
  separate(variable, c("variable", "age")) %>% 
  rename(value = simulated) %>% 
    mutate(site = site2) %>% 
  select(-site2)
monthly <- daily %>% 
  group_by(site, date = floor_date(date, "month"), variable, age) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            value = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE))
cols_laid <- c("young" = "#2bd22c", "mature" = "#197b14", "old" = "#ffa006")
```

```{r laiadaily}
#| message: false
#| warning: false
#| fig-cap: "Daily and monthly means of leaf area index for Paracou and Tapajos with leaf cohorts of yound, mature and old leaves. Dark lines are the monthly means, semi-transparent lines are the daily means variations."
daily %>% 
  ggplot(aes(date, value, col = age)) +
  geom_line(alpha = 0.5) +
  geom_line(data = monthly) +
  facet_wrap(~ site, scales = "free_x") +
  theme_bw() +
  theme(legend.position = "bottom") +
  xlab("") + 
  ylab(expression("Leaf Area Index ["~m^2~m^{-2}~"]")) +
  scale_color_manual("", values = as.vector(cols_laid[c("mature", "old", "young")]))
```

```{r laia15days}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of leaf area index for Paracou and Tapajos with leaf cohorts of yound, mature and old leaves. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
daily %>% 
  group_by(site, variable, age, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date)) %>%  
  group_by(site, variable, age, week) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  mutate(type = "TROLL") %>% 
  bind_rows(read_tsv("data/fluxes/lai_age.tsv") %>% 
              filter(type == "time series") %>% 
              mutate(type = "Yang et al. (2023)\nReanalysis")) %>% 
  bind_rows(readxl::read_xlsx("data/fluxes/Data_LAI_new.xlsx", 2) %>% 
              rename(young = `Obs_LAIyoung (m^2 m^-2)`,
                     mature = `Obs_LAImature (m^2 m^-2)`,
                     old = `Obs_LAIold (m^2 m^-2)`) %>% 
              mutate(site = "Tapajos", type = "Wu et al. (2016)\nPhenoCam") %>% 
              mutate(date = as_date(paste0("2010-", month, "-15"))) %>% 
              mutate(week = week(date)) %>% 
              select(site, week, type, young, mature, old) %>% 
              gather(age, m, -site, -week, -type)) %>% 
  mutate(type = factor(type, levels = c("TROLL", "Wu et al. (2016)\nPhenoCam",
                                        "Yang et al. (2023)\nReanalysis"))) %>% 
  ggplot(aes(week, m)) +
  geom_ribbon(aes(ymin = l, ymax = h, fill = age), col = NA, alpha = 0.2) +
  geom_smooth(aes(col = age), se = FALSE) +
  theme_bw() +
  scale_fill_discrete("") +
  scale_color_discrete("") +
  facet_grid(site~ type) +
  scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) + 
  ylab(expression("Leaf Area Index ["~m^2~m^{-~2}~"]")) + xlab("") +
  scale_color_manual("", values = as.vector(cols_laid[c("mature", "old", "young")])) +
  scale_fill_manual("", values = as.vector(cols_laid[c("mature", "old", "young")])) +
  theme(legend.position = "bottom")
```

```{r laia15daysb}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of leaf area index for Paracou and Tapajos with leaf cohorts of yound, mature and old leaves. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
daily %>% 
  group_by(site, variable, age, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date)) %>%  
  group_by(site, variable, age, week) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  mutate(type = "TROLL") %>% 
  bind_rows(read_tsv("data/fluxes/lai_age.tsv") %>% 
              filter(type == "time series") %>% 
              mutate(type = "Yang et al. (2023) Renalaysis")) %>% 
  bind_rows(readxl::read_xlsx("data/fluxes/Data_LAI_new.xlsx", 2) %>% 
              rename(young = `Obs_LAIyoung (m^2 m^-2)`,
                     mature = `Obs_LAImature (m^2 m^-2)`,
                     old = `Obs_LAIold (m^2 m^-2)`) %>% 
              mutate(site = "Tapajos", type = "Wu et al. (2016) PhenoCam") %>% 
              mutate(date = as_date(paste0("2010-", month, "-15"))) %>% 
              mutate(week = week(date)) %>% 
              select(site, week, type, young, mature, old) %>% 
              gather(age, m, -site, -week, -type)) %>% 
  mutate(type = factor(type, levels = c("TROLL", "Wu et al. (2016) PhenoCam",
                                        "Yang et al. (2023) Renalaysis"))) %>% 
  group_by(site, variable, age, type) %>% 
  mutate(m = as.vector(scale(m))) %>% 
  mutate(age = factor(age, levels = c("old", "mature", "young"))) %>% 
  ggplot(aes(week, m)) +
  geom_smooth(aes(col = type), se = FALSE) +
  theme_bw() +
  scale_color_manual("", values = c("#0da1f8",  "#3f3f3f", "#fb7754")) +
  facet_grid(age ~ site) +
  scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) + 
  ylab(expression("Normalised Leaf Area Index")) + xlab("") +
  theme(legend.position = "bottom")
```

```{r laistrata}
#| message: false
#| eval: false
#| fig-cap: "Mean annual cycle from monthly means of leaf area index per strata at Tapajos. Rectangles in the background correspond to the site’s climatological dry season."
troll <- list(
    lai_young = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAIyoung.txt"),
    lai_mature = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAImature.txt") %>% 
      mutate(iter = as.numeric(iter)) %>% na.omit(),
    lai_old = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAIold.txt") %>% 
      mutate(iter = as.numeric(iter)) %>% na.omit()
  ) %>% bind_rows(.id = "variable") %>% 
  mutate(date = as_date("2004/01/01")+iter) %>% 
  select(-iter) %>% 
  gather(height, value, -date, -variable) %>% 
  separate(height, c("h", "height"), convert = T) %>% 
  mutate(canopy = ifelse(height < 20, "lower", "upper")) %>% 
  group_by(canopy, date) %>% 
  summarise(value = sum(value)) %>% 
  mutate(site = "Tapajos", variable = "LAI") %>% 
  mutate(week = week(date), year = year(date)) %>% 
  mutate(type = "TROLL")
obs <- read_tsv("outputs/lai_tapajos_strat.tsv") %>% 
  mutate(type = "LAI (Smith et al., 2019)")
bind_rows(troll, obs) %>% 
ggplot(aes(week, value)) +
    geom_rect(aes(xmin = week, xmax = end), fill  = "#fff4e0",
            ymin = -Inf, ymax = Inf, alpha = 0.5,
            data = data.frame(week = week(as_date(c("2000-06-15"))),
                              value = -Inf,
                              end = week(as_date(c("2000-11-1"))))) +
  geom_line(aes(group = paste(year, canopy), col = canopy), alpha = 0.5) +
  geom_smooth(aes(col = canopy), se = FALSE) +
  theme_bw() +
  theme(legend.position = "bottom") +
  ylab(expression("Leaf Area Index ["~m^2~m^{-~2}~"]")) + xlab("") +
  scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) +
  facet_wrap(~ type)
```

### Evapotranspiration

```{r etdata}
#| message: false
daily <- read_tsv("outputs/evaluation_fluxes2.tsv") %>% 
  filter(variable == "et") %>% 
  mutate(site2 = site, site = "Tapajos") %>% 
  left_join(read_tsv("outputs/fluxnet_fluxes.tsv") %>% 
              mutate(observed = value*20) %>% 
              select(-value)) %>% 
  left_join(read_tsv("outputs/fluxnet_fluxes.tsv") %>% 
              filter(variable %in% c("par", "vpd_max", "temperature", "ws")) %>% 
              rename(determinant = variable, determinant_value = value)) %>% 
    mutate(site = site2) %>% 
  select(-site2) %>% 
  gather(type, value, -site, -date, -variable, -determinant, -determinant_value)
monthly <- daily %>% 
  group_by(site, date = floor_date(date, "month"), variable, type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            value = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE))
daily_etp <- read_tsv("outputs/fluxnet_climate.tsv") %>% 
  mutate(ws = ws) %>% # u10
  mutate(rgnet = snet) %>% # already rgnet
  mutate(es = 0.6108*exp((17.27*temperature)/(237.3+temperature))) %>% 
  mutate(ea = es - vpd) %>% 
  mutate(delta = 4098*es/(237.3+temperature)) %>% 
  mutate(z = 30) %>% # with 30-m canopy
  mutate(p = 101.3*((293-0.0065*z)/293)^5.26) %>% 
  mutate(gamma = 0.655*10^(-3)*p) %>% 
  mutate(etp = (0.408*delta*rgnet+gamma*(900/(temperature+273))*ws*vpd)/
           (delta+gamma*(1+0.34*ws))) %>% 
  mutate(etp = etp/1000) %>% 
  group_by(site, date = date(time)) %>% 
  summarise(value = sum(etp)) %>% 
  mutate(type = "etp") %>% 
  select(site, date, type, value)
```

```{r etdaily}
#| message: false
#| warning: false
#| fig-cap: "Daily and monthly means of evapotranpsiration for Paracou and Tapajos. Dark lines are the monthly means, semi-transparent lines are the daily means variations"
daily %>% 
  ggplot(aes(date, value, col = type)) +
  geom_line(alpha = 0.5) +
  geom_line(data = monthly) +
  facet_wrap(~ site, nrow = 2) +
  theme_bw() +
  theme(legend.position = "bottom") +
  xlab("") + 
  ylab(expression("Evapotranspiration ["~mm~day^{-~1}~"]")) +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL"))
```

```{r et15days}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of evapotranspiration for Paracou and Tapajos. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
daily %>% 
  bind_rows(daily_etp) %>% 
  group_by(site, variable, type, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date)) %>%  
  group_by(site, variable, type, week) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  ggplot(aes(week, m)) +
  geom_rect(aes(xmin = week, xmax = end), fill  = "#fff4e0",
           ymin = -Inf, ymax = Inf, alpha = 0.5,
           data = data.frame(week = week(as_date(c("2000-8-1", "2000-06-15"))),
                             m = -Inf,
                             end = week(as_date(c("2000-12-1", "2000-11-1"))),
                             site = c("Paracou", "Tapajos"))) +
  geom_ribbon(aes(ymin = l, ymax = h, fill = type), col = NA, alpha = 0.2) +
  geom_smooth(aes(col = type), se = FALSE) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_discrete("") +
  scale_color_discrete("") +
  facet_wrap(~ site, scales = "free_x") +
    scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) + 
  ylab(expression("Evapotranspiration ["~mm~day^{-~1}~"]")) + xlab("") +
    scale_color_manual("", values = as.vector(cols[c("sat", "obs", "sim")]), 
                     labels = c("Potential", "Tower", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("sat", "obs", "sim")]), 
                     labels = c("Potential", "Tower", "TROLL"))
```

```{r etdet}
#| message: false
#| warning: false
#| fig-cap: "Daily averages of evapotranspiration as a function of vapour pressure deficit, incoming photosynthetically active radiation, temperature, and wind speed for model-, satellite- and tower-based estimates at Paracou and Tapajos."
daily %>% 
  mutate(determinant_value = ifelse(determinant == "par", 
                                    determinant_value/10^2, determinant_value)) %>% 
  mutate(det_long = recode(determinant, 
                           "par" = 'Incoming~PAR~"["~mol~m^{-~2}~day^{-~1}~"]"',
                           "temperature" = 'Temperature~"["~degree~C~"]"',
                            "vpd_max" = '"Vapour Pressure Deficit ["~kPa~day^{-~1}~"]"',
                           "ws" = 'Wind~Speed~"["~m^{2}~s^{-~1}~"]"')) %>% 
  ggplot(aes(determinant_value, value, col = type)) +
  geom_point(alpha = 0.1) +
  theme_bw() +
  facet_grid(site ~ det_long, scales = "free", labeller = label_parsed) +
  theme(legend.position = "bottom") +
  geom_smooth(method = "lm", formula = "y ~ 1+log(x+10^-6)", se = FALSE) +
  ylab(expression("Evapotranspiration ["~mm~day^{-~1}~"]")) + 
  xlab("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL")) +
  ylim(0, 5.5) +
  ggpubr::stat_cor()
```

```{r etevalplot}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of simulated versus observed daily means of ET in Paracou and Tapajos."
daily %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  ggplot(aes(simulated ,observed, col = yday(date))) +
  facet_wrap(~ site) +
  theme_bw() +
  geom_point() +
  scale_color_viridis_c("Day") +
  geom_abline(col = "red") +
  ylab(expression("Observed ET ["~mm~day^{-~1}~"]")) + 
  xlab(expression("Simulated ET ["~mm~day^{-~1}~"]")) + 
  scale_color_viridis_c("Day") +
  ggpubr::stat_cor()
```

```{r etevaltab}
daily %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  na.omit() %>% 
  nest_by(site, variable) %>% 
  mutate(R2 = summary(lm(observed ~ 0 + simulated, data = data))$r.squared,
         CC = cor(data$simulated, data$observed),
         RMSEP = sqrt(mean((data$simulated-data$observed)^2)),
         RRMSEP = sqrt(mean((data$simulated-data$observed)^2))/mean(data$observed),
         SD =sd(data$simulated-data$observed),
         RSD =sd(data$simulated-data$observed)/mean(data$observed)) %>% 
  select(-data) %>% 
  knitr::kable(caption = "Evaluation fo daily means of ET at Paracou and Tapajos.")
```

### Relative Soil Water Content

```{r rswcdata}
#| message: false
#| warning: false
daily <- read_tsv("outputs/evaluation_fluxes2.tsv") %>% 
  filter(variable == "rswc10") %>% 
  mutate(site2 = site, site = "Tapajos") %>% 
  left_join(read_tsv("outputs/guyaflux_swc.tsv") %>% 
              filter(variable == "swc10") %>% 
              group_by(site, year = year(date)) %>% 
              mutate(observed = value / quantile(value, 0.95, na.rm = T)) %>% 
              mutate(observed = ifelse(observed > 1, 1, observed)) %>% 
              ungroup() %>% 
              mutate(variable = "rswc10") %>% 
              select(-year, -value)) %>% 
    mutate(site = site2) %>% 
  select(-site2) %>% 
  gather(type, value, -site, -date, -variable) %>% 
  na.omit()
monthly <- daily %>% 
  group_by(site, date = floor_date(date, "month"), variable, type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            value = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE))
```

```{r rswcdaily}
#| message: false
#| warning: false
#| fig-cap: "Daily and monthly means of relative soil water content for Paracou and Tapajos. Dark lines are the monthly means, semi-transparent lines are the daily means variations."
daily %>% 
  ggplot(aes(date, value, col = type)) +
  geom_line(alpha = 0.5) +
  geom_line(data = monthly) +
  facet_wrap(~ site, scales = "free_x") +
  theme_bw() +
  theme(legend.position = "bottom") +
  xlab("") + 
  ylab(expression("Relative Soil Water Content ["~"%"~"]")) +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL"))
```

```{r rswc15days}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of relative soil water content for Paracou and Tapajos. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
daily %>% 
  group_by(site, variable, type, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date), year = year(date), m = value) %>% 
  na.omit() %>% 
  ggplot(aes(week, m)) +
  geom_rect(aes(xmin = week, xmax = end), fill  = "#fff4e0",
           ymin = -Inf, ymax = Inf, alpha = 0.5,
           data = data.frame(week = week(as_date(c("2000-8-1", "2000-06-15"))),
                             m = -Inf,
                             end = week(as_date(c("2000-12-1", "2000-11-1"))),
                             site = c("Paracou", "Tapajos"))) +
  geom_line(aes(group = paste(year, type), col = type), alpha = 0.5) +
  geom_smooth(aes(col = type), se = FALSE) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_discrete("") +
  scale_color_discrete("") +
  facet_wrap(~ site, scales = "free_x") +
    scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) + 
  ylab(expression("Relative Soil Water Content ["~"%"~"]")) + xlab("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL"))
```

## Structure

The main development of TROLL version 4 is the inclusion of a new explicit modelling of daily water and carbon fluxes as well as a new leaf phenology. We thus focused TROLL version 4 evaluation on fluxes, as forest structure and composition was extensively assessed in @maréchaux2017 . However here, we quickly investigate back forest structure and composition in Paracou and Tapajos.

```{r simforestdata}
#| eval: false
files <- list.files("results2/run3/", pattern = "final_pattern.txt", 
                    recursive = T, full.names = T) 
names(files) <- list.files("results2/run3/", pattern = "final_pattern.txt", 
                    recursive = T, full.names = F) 
troll_forest <- files %>% 
  lapply(vroom::vroom) %>% 
  bind_rows(.id = "file") %>% 
  separate(file, "sim", "/") %>% 
  separate(sim, c("site", "repetition")) %>%
  mutate(repetition = as.numeric(gsub("R", "", repetition))) %>% 
  mutate(species = gsub("_", " ", s_name)) %>% 
  mutate(dbh = dbh*100)
write_tsv(troll_forest, "outputs/evaluation_forest2.tsv")
```

### Forest

```{r str}
#| message: false
structure <- read_tsv("outputs/evaluation_forest2.tsv") %>% 
  filter(dbh >= 10) %>% 
  mutate(plot = repetition) %>% 
  select(site, plot, dbh) %>% 
  mutate(dbh_class = cut(dbh, breaks = seq(10, 200, by = 10), 
                         labels = seq(10, 190, by = 10)+5)) %>% 
  mutate(dbh_class = as.numeric(as.character(dbh_class))) %>% 
  group_by(site, plot, dbh_class) %>% 
  summarise(abundance = n()/4,
            ba = sum((dbh/2)^2*pi)/10^4/4) %>% 
  mutate(log_abundance = log10(abundance)) %>% 
  gather(variable, simulated, -site, -dbh_class, -plot) %>% 
  full_join(read_tsv("outputs/structure.tsv") %>% 
              filter(type != "understory") %>% 
              select(-type)) %>% 
  gather(type, value, -site, -dbh_class, -variable, -plot) %>% 
  group_by(site, dbh_class, variable, type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = quantile(value, 0.5, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  na.omit() %>% 
  mutate(varlong = recode(variable, "ba" = 'Basal~area~"["~m^{2}~ha^{-~1}~"]"',
                          "log_abundance" = 'Log[10]~abundance~"["~ha^{-~1}~"]"'))
```

```{r dbhstr}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of the size structure estimated by TROLL at the Paracou and Tapajos sites, expressed in terms of abundance and basal area. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
labs <- structure %>% 
  filter(variable %in% c("ba", "log_abundance")) %>% 
  mutate(m = ifelse(variable == "log_abundance", 10^m, m)) %>% 
  group_by(variable, varlong, type, site) %>% 
  summarise(total = sum(m)) %>% 
  group_by(variable, site) %>% 
  pivot_wider(names_from = type, values_from = total) %>% 
  mutate(label = paste0("Field: ", round(observed), "\nTROLL: ", round(simulated))) %>% 
  mutate(dbh_class = 120) %>% 
  mutate(m = ifelse(variable == "log_abundance", 1.5, 5)) 
filter(structure, variable %in% c("ba", "log_abundance")) %>% 
  ggplot(aes(dbh_class, m)) +
  geom_linerange(aes(ymin = l, ymax = h, col = type)) +
  geom_point(aes(col = type)) +
  geom_line(aes(col = type)) +
  theme_bw() +
  facet_grid(varlong ~ site, scales = "free_y", labeller = label_parsed) +
  xlab("DBH [ cm ]") + ylab("") +
  scale_color_discrete("") +
  theme(legend.position = "bottom") +
  geom_text(data = labs, aes(label = label)) +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
```

```{r dbhstreval}
#| message: false
#| warning: false
#| fig-cap: "Quantiles comparisons of the size structure estimated by TROLL at the Paracou and Tapajos sites, expressed in terms of abundance and basal area. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
structure %>% 
  filter(variable != "abundance") %>% 
  gather(quantile, value, -site, -dbh_class, -variable, -varlong, -type) %>% 
  mutate(type = str_sub(type, 1, 3)) %>% 
  mutate(quantile = paste0(quantile, "_", type)) %>% 
  select(-type) %>% 
  pivot_wider(names_from = quantile, values_from = value) %>% 
  ggplot(aes(m_obs, m_sim, col = dbh_class)) +
  geom_linerange(aes(ymin = l_sim, ymax = h_sim)) +
  geom_linerange(aes(xmin = l_obs, xmax = h_obs)) +
  geom_point() +
  facet_wrap(~ site ~ varlong, scales = "free", labeller = label_parsed) +
  theme_bw() +
  geom_abline() +
  ylab("Simulated") + xlab("Observed") +
  scale_color_viridis_c(guide = "none") +
  ggpubr::stat_cor() 
```

## Composition

### Species

```{r compodata}
#| message: false
#| warning: false
compositon <- read_tsv("outputs/evaluation_forest2.tsv") %>% 
  filter(dbh >= 10) %>% 
  mutate(plot = repetition) %>% 
  mutate(species = gsub("_", " ", s_name)) %>% 
  select(site, plot, species) %>% 
  group_by(site, plot, species) %>% 
  summarise(simulated = n()/4) %>% 
  mutate(variable = "abundance") %>% 
  select(site, plot, species, variable, simulated) %>% 
  full_join(read_tsv("outputs/composition.tsv")) %>% 
  gather(type, value, -site, -plot, -variable, -species) %>% 
  group_by(site, plot, variable, type) %>% 
  arrange(desc(value)) %>% 
  mutate(rank = 1:n()) %>% 
  group_by(site, rank, type, variable) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = quantile(value, 0.5, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  filter(rank < 115)
```

```{r compofig}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of the species composition estimated by TROLL at the Paracou and Tapajos sites expressed in terms of species rank-abundance curve. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
compositon %>% 
  ggplot(aes(rank, m, col = type)) +
  geom_line(aes(y = l), linewidth = 0.5, linetype = "dashed") +
  geom_line(aes(y = h), linewidth = 0.5, linetype = "dashed") +
  geom_line() +
  theme_bw() +
  facet_wrap(~ site) +
  xlab("Rank") + ylab(expression(Abundance~"["~ha^{-~1}~"]")) +
  scale_color_discrete("") +
  theme(legend.position = "bottom") +
  scale_y_log10()  +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
```

```{r compoquant}
#| message: false
#| warning: false
#| fig-cap: "Quantiles comparisons of the species composition estimated by TROLL at the Paracou and Tapajos sites expressed in terms of species rank-abundance curve. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
compositon %>% 
  ungroup() %>% 
  gather(quantile, value, -site, -rank, -variable, -type) %>% 
  mutate(type = str_sub(type, 1, 3)) %>% 
  mutate(quantile = paste0(quantile, "_", type)) %>% 
  select(-type) %>% 
  pivot_wider(names_from = quantile, values_from = value) %>% 
  ggplot(aes(m_obs, m_sim, col = rank)) +
  geom_linerange(aes(ymin = l_sim, ymax = h_sim)) +
  geom_linerange(aes(xmin = l_obs, xmax = h_obs)) +
  geom_point() +
  facet_wrap(~ site, scales = "free") +
  theme_bw() +
  geom_abline() +
  ylab(expression("Simulated abundance ["~ha^{-~1}~"]")) +
  xlab(expression("Observed abundance ["~ha^{-~1}~"]")) +
  scale_y_log10() + scale_x_log10() +
  scale_color_viridis_c(guide = "none") +
  ggpubr::stat_cor()
```

### Functional

```{r ftdata}
#| message: false
#| warning: false
troll_traits <- list(
    read_tsv("outputs/paracou_species_troll.tsv"),
    read_tsv("outputs/tapajos_species_troll.tsv")
) %>% bind_rows() %>% 
  unique() %>% 
  rename_all(~ gsub("s_", "", .)) %>% 
  select(-seedmass, -regionalfreq) %>% 
  rename(species = name) %>% 
  mutate(species = gsub("_", " ", species)) %>% 
  gather(trait, trait_value, -species)
troll_traitdist <- read_tsv("outputs/evaluation_forest2.tsv") %>% 
  filter(dbh >= 10) %>% 
  mutate(plot = repetition) %>% 
  select(site, plot, species) %>% 
  left_join(troll_traits)
all_traits_q <- bind_rows(
  mutate(troll_traitdist, type = "sim"),
  mutate(read_tsv("outputs/functional_composition.tsv"), type = "obs")
) %>% 
  group_by(site, trait, plot, type) %>% 
  summarise(quantile = list(quantile(trait_value, seq(0, 1, length.out = 100)))) %>% 
  unnest_longer(quantile) %>% 
  group_by(site, trait, type, quantile_id)%>% 
  summarise(l = quantile(quantile, 0.025, na.rm = TRUE), 
            m = quantile(quantile, 0.5, na.rm = TRUE), 
            h = quantile(quantile, 0.975, na.rm = TRUE)) %>% 
  gather(quantile, value, -site, -trait, -type, -quantile_id) %>% 
  mutate(quantile = paste0(quantile, "_", type)) %>% 
  ungroup() %>% 
  select(-type) %>% 
  pivot_wider(names_from = quantile, values_from = value)
```

```{r fttapfig}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of the functional composition estimated by TROLL at the Tapajos site expressed in terms of density distribution per trait and site. The analyses have been done at the genus level in Tapajos."
read_tsv("outputs/functional_composition.tsv") %>% 
  filter(site == "Tapajos") %>% 
  ggplot(aes(trait_value, group = plot)) +
  geom_density(aes(col = "Observed")) +
  geom_density(aes(col = "Simulated"),
               data = filter(troll_traitdist, site == "Tapajos")) +
  facet_wrap(~ trait, scales = "free") +
  theme_bw() +
  ggtitle("Tapajos Genus level", "19,188 inds represented on 19,499 (98.65%)") +
  theme(axis.title = element_blank(), legend.position = "bottom") +
  scale_color_discrete("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
```

```{r ftaptquant}
#| message: false
#| warning: false
#| fig-cap: "Quantiles comparisons of the functional composition estimated by TROLL at the Tapajos site expressed in terms of density distribution per trait and site. The analyses have been done at the genus level in Tapajos."
all_traits_q %>% 
  filter(site == "Tapajos") %>% 
  ggplot(aes(m_obs, m_sim)) +
  geom_abline(col = "blue") +
  geom_linerange(aes(ymin = l_sim, ymax = h_sim), alpha = .5) +
  geom_linerange(aes(xmin = l_obs, xmax = h_obs), alpha = .5) +
  geom_point() +
  theme_bw() +
  facet_wrap(~ trait, scales = "free") +
  ggtitle("Tapajos Genus level", "19,188 inds represented on 19,499 (98.65%)") +
  xlab("Observed trait quantiles") +
  ylab("Simulated trait quantiles") +
  ggpubr::stat_cor() + 
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
```
