```{r setup}
#| include: false 
library(tidyverse) 
cols <- c("obs" = "#3f3f3f", "sim" = "#0da1f8", "sat" = "#fb7754")
```

# Evaluation

Evaluation of the TROLL version 4 simulations of daily fluxes and the final structure and composition of the forest in relation to field observations and remote sensing at two Amazonian sites.

## Fluxes

```{r fluxes}
#| eval: false
trollwater <- list(
  Paracou = read_tsv("results/run3/Paracou_R1/Paracou_R1_0_water_balance.txt") %>% 
     mutate(date = as_date("2004/01/01")+iter),
  Tapajos = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_water_balance.txt") %>% 
     mutate(date = as_date("2002/01/01")+iter)
) %>% bind_rows(.id = "site") %>% 
  mutate(swc10 = SWC_0, swc20 = SWC_1, swc80 = SWC_3,
         et = (transpitation_0 + transpitation_1 + transpitation_2 + 
                 transpitation_3 + transpitation_4 + evaporation)*1000) %>% 
  select(site, date, swc10, swc20, swc80, et) %>% 
  group_by(site, year = year(date)) %>% 
  mutate(rswc10 = swc10/quantile(swc10, 0.95, na.rm = T)) %>% 
  ungroup() %>% 
  select(-year) %>% 
  gather(variable, simulated, -site, -date)
trollsum <- list(
  Paracou = read_tsv("results/run3/Paracou_R1/Paracou_R1_0_sumstats.txt") %>% 
     mutate(date = as_date("2004/01/01")+iter),
  Tapajos = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_sumstats.txt") %>% 
     mutate(date = as_date("2002/01/01")+iter)
) %>% bind_rows(.id = "site") %>% 
  select(-npp, -rday, -rnight, -rstem) %>% 
  mutate(litter = litterfall*10^2, gpp = gpp*10^2*365/10^3) %>% 
  select(-iter, -litterfall) %>% 
  gather(variable, simulated, -site, -date)
lai <- list(
  Paracou = read_tsv("results/run3/Paracou_R1/Paracou_R1_0_LAIdynamics.txt") %>% 
     mutate(date = as_date("2004/01/01")+iter),
  Tapajos = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAIdynamics.txt") %>% 
     mutate(date = as_date("2002/01/01")+iter)
) %>% bind_rows(.id = "site") %>% 
  mutate(variable = "lai", simulated = LAI) %>% 
  select(site, date, variable, simulated)
lai_age <- list(
  Paracou = list(
    lai_young = read_tsv("results/run3/Paracou_R1/Paracou_R1_0_LAIyoung.txt"),
    lai_mature = read_tsv("results/run3/Paracou_R1/Paracou_R1_0_LAImature.txt") %>% 
      mutate(iter = as.numeric(iter)) %>% na.omit(),
    lai_old = read_tsv("results/run3/Paracou_R1/Paracou_R1_0_LAIold.txt") %>% 
      mutate(iter = as.numeric(iter)) %>% na.omit()
  ) %>% bind_rows(.id = "variable"),
  Tapajos = list(
    lai_young = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAIyoung.txt"),
    lai_mature = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAImature.txt") %>% 
      mutate(iter = as.numeric(iter)) %>% na.omit(),
    lai_old = read_tsv("results/run3/Tapajos_R1/Tapajos_R1_0_LAIold.txt") %>% 
      mutate(iter = as.numeric(iter)) %>% na.omit()
  ) %>% bind_rows(.id = "variable")
) %>% bind_rows(.id = "site") %>% 
  mutate(date = as_date("2004/01/01")+iter) %>% 
  select(-iter) %>% 
  gather(height, value, -date, -variable, -site) %>% 
  group_by(site, variable, date) %>% 
  summarise(simulated = sum(value))
bind_rows(trollwater, trollsum, lai, lai_age) %>% 
  write_tsv("outputs/evaluation_fluxes.tsv")
```

### Growth Primary Productivity

The new version of TROLL correctly simulated the phenology of Growth Primary Productivity (GPP, kgC/m2/yr) with a lower GPP in wet season and higher values in the dry season. However, TROLL version 4 is globally overestimating GPP with daily values overlapping wet season values but significantly higher values in dry season with a pike around 5 instead of 4 kgC/m2/yr. Remotely-sensed observation from TROPOMI Solar Induced Fluorescence showed under-estimated values of GPP between 2.5 and 3.5 kgC/m2/yr monthly means but with a similar phenology. The new version of TROLL seems to be too deterministic in the relation between available light (incoming PAR mol/m2/day) and GPP with a correlation coefficient of 0.94 against an observed coefficient of 0.58. The overestimation of GPP seems to be linked to over-efficient GPP for high light availability (PAR above 5 mol/m2/day). Globally, simulated GPP showed a very good evaluation with a correlation coefficient of 0.59 in Paracou and 0.46 in Tapajos against daily observations from eddy-flux towers, and corresponding RMSEP of respectively 0.9 and 1.6 kgC/m2/yr.

```{r gppdata}
#| message: false
daily <- read_tsv("outputs/evaluation_fluxes.tsv") %>% 
  filter(variable == "gpp") %>% 
  left_join(read_tsv("outputs/fluxnet_fluxes.tsv") %>% 
              mutate(observed = value*10^2*365/10^3) %>% 
              select(-value)) %>% 
  left_join(read_tsv("outputs/fluxnet_fluxes.tsv") %>% 
              filter(variable == "par") %>% 
              rename(par = value) %>% 
              select(-variable)) %>% 
  left_join(read_tsv("data/fluxes/rtsif.tsv") %>% 
              mutate(satellite = rtsif*15.343*365/10^3) %>% 
              select(-rtsif)) %>% 
  gather(type, value, -site, -date, -variable, -par)
monthly <- daily %>% 
  group_by(site, date = floor_date(date, "month"), variable, type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            value = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE))
```

```{r gppdaily}
#| message: false
#| warning: false
#| fig-cap: "Daily and monthly means of growth primary productivity for Paracou and Tapajos. Dark lines are the monthly means, semi-transparent lines are the daily means variations with the exception of satellite data for which data are available only every 8 days."
g <- daily %>% 
  ggplot(aes(date, value, col = type)) +
  geom_line(alpha = 0.5) +
  geom_line(data = monthly) +
  facet_wrap(~ site, nrow = 2) +
  theme_bw() +
  theme(legend.position = "bottom") +
  xlab("") +
  ylab(expression("Growth Primary Productivity ["~kgC~m^{-2}~yr^{-1}~"]")) +
  scale_color_manual("", values = as.vector(cols[c("obs", "sat", "sim")]), 
                     labels = c("Tower", "Satellite", "TROLL"))
ggsave("figures/fs03.png", g, dpi = 300, width = 10, height = 5, bg = "white")
g
```

```{r gpp15days}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of growth primary productivity for Paracou and Tapajos. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
g <- daily %>% 
  group_by(site, variable, type, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date)) %>%  
  group_by(site, variable, type, week) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  ggplot(aes(week, m)) +
  geom_rect(aes(xmin = week, xmax = end), fill  = "#fff4e0",
           ymin = -Inf, ymax = Inf, alpha = 0.5,
           data = data.frame(week = week(as_date(c("2000-8-1", "2000-06-15"))),
                             m = -Inf,
                             end = week(as_date(c("2000-12-1", "2000-11-1"))),
                             site = c("Paracou", "Tapajos"))) +
  geom_ribbon(aes(ymin = l, ymax = h, fill = type), col = NA, alpha = 0.2) +
  geom_smooth(aes(col = type), se = FALSE) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_discrete("") +
  scale_color_discrete("") +
  facet_wrap(~ site, scales = "free_x") +
    scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) +
  ylab(expression("Growth Primary Productivity ["~kgC~m^{-~2}~yr^{-~1}~"]")) +
  xlab("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sat", "sim")]), 
                     labels = c("Tower", "Satellite", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("obs", "sat", "sim")]), 
                     labels = c("Tower", "Satellite", "TROLL"))
ggsave("figures/f01.png", g, dpi = 300, width = 8, height = 5, bg = "white")
g
```

```{r gpppar}
#| message: false
#| warning: false
#| fig-cap: "Daily averages of growth primary productivity as a function of incoming photosynthetically active radiation for model-, satellite- and tower-based estimates at Paracou and Tapajos."
g <- daily %>% 
  ggplot(aes(par/10^2, value, col = type)) +
  geom_point(alpha = 0.1) +
  theme_bw() +
  facet_wrap(~ site) +
  theme(legend.position = "bottom") +
  geom_smooth(method = "lm", formula = "y ~ 1+log(x)", se = FALSE) +
  facet_wrap(~ site) +
  ylab(expression("Growth Primary Productivity ["~kgC~m^{-~2}~yr^{-~1}~"]")) +
  xlab(expression("Incoming PAR ["~mol~m^{-~2}~day^{-~1}~"]")) +
  scale_color_manual("", values = as.vector(cols[c("sim", "sat", "obs")]), 
                     labels = c("Tower", "Satellite", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("obs", "sat", "sim")]), 
                     labels = c("Tower", "Satellite", "TROLL")) +
  ylim(0, NA) +
  ggpubr::stat_cor()
ggsave("figures/f03.png", g, dpi = 300, width = 8, height = 5, bg = "white")
g
```

```{r gppevalplot}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of simulated versus observed daily means of GPP in Paracou and Tapajos."
daily %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  gather(type, observed, -site, -date, -variable, -par, -simulated) %>% 
  ggplot(aes(simulated,observed, col = yday(date))) +
  facet_grid(site ~ type) +
  theme_bw() +
  geom_point() +
  scale_color_viridis_c("Day") +
  geom_abline(col = "red") +
  xlab(expression("Observed GPP ["~kgC~m^{-~2}~yr^{-~1}~"]")) +
  ylab(expression("Simulated GPP ["~kgC~m^{-~2}~yr^{-~1}~"]")) +
  scale_color_viridis_c("Day") +
  ggpubr::stat_cor()
```

```{r evaltab}
daily %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  gather(type, observed, -site, -date, -variable, -par, -simulated) %>% 
  na.omit() %>% 
  nest_by(site, variable, type) %>% 
  mutate(R2 = summary(lm(observed ~ 0 + simulated, data = data))$r.squared,
         CC = cor(data$simulated, data$observed),
         RMSEP = sqrt(mean((data$simulated-data$observed)^2)),
         RRMSEP = sqrt(mean((data$simulated-data$observed)^2))/mean(data$observed),
         SD =sd(data$simulated-data$observed),
         RSD =sd(data$simulated-data$observed)/mean(data$observed)) %>% 
  select(-data) %>% 
  knitr::kable(caption = "Evaluation fo daily means of GPP at Paracou and Tapajos.")
```

### Leaf Area Index

We had multiples data to evaluate canopy dynamics and resulting Leaf Area Index (LAI, m2/m2) that were not in agreement and unfortunately not in the same time period. LAI from MODIS shows a base value around 6 m2/m2 most of the years and a small increase below 0.2 m2/m3 in the dry season that pike in the middle of the dry season at both Paracou and Tapajos. Field measures with drone lidar showed a greater variation in Paracou with lowest values of 5.5 m2/m2 in April to June and highest values of almost 6 m2/m2 in December. Oppositely, field measures with terrestrial lidar in Tapajos showed no variation of LAI stable around 5.75 m2/m2 the whole year. This results thus question the use of MODIS LAI for TROLL evaluation. Indeed simulated LAI followed also the same phenology with an crease of LAI during the dry season but with values matching drone data in Paracou and not MODIS product. In Tapajos, the simulations showed even higher variations of LAI, that did not correspond to both MODIS and terrestrial LAD. Globally, simulated LAI showed a weak evaluation with a correlation coefficient of 0.37 in Paracou and 0.63 in Tapajos against 8-day observations from MODIS satellites, and corresponding RMSEP of respectively 0.3 and 0.1 m2/m2.

```{r laidata}
#| message: false
daily <- read_tsv("outputs/evaluation_fluxes.tsv") %>% 
  filter(variable == "lai") %>% 
  select(-variable) %>% 
  mutate(type = "simulated") %>% 
  rename(value = simulated) %>% 
  bind_rows(read_tsv("outputs/lai.tsv") %>% 
              rename(type = variable))
monthly <- daily %>% 
  group_by(site, date = floor_date(date, "month"), type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            value = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE))
```

```{r laidaily}
#| message: false
#| warning: false
#| fig-cap: "Daily and monthly means of leaf area index for Paracou and Tapajos. Dark lines are the monthly means, semi-transparent lines are the daily means variations with the exception of satellite data for which data are available only every 8 days."
daily %>% 
  ggplot(aes(date, value, col = type)) +
  geom_line(alpha = 0.5) +
  geom_line(data = monthly) +
  facet_wrap(~ site, scales = "free_x") +
  theme_bw() +
  theme(legend.position = "bottom") +
  xlab("") + 
  ylab(expression("Leaf Area Index ["~m^2~m^{-2}~"]")) +
  scale_color_manual("", values = as.vector(cols[c("obs", "sat", "obs", "sim")]), 
                     labels = c("Terrestrial", "Satellite", "Drone", "TROLL"))
```

```{r lai15days}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of leaf area index for Paracou and Tapajos. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
g <- daily %>% 
  group_by(site, type, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date)) %>%  
  group_by(site, type, week) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  ggplot(aes(week, m)) +
  geom_rect(aes(xmin = week, xmax = end), fill  = "#fff4e0",
           ymin = -Inf, ymax = Inf, alpha = 0.5,
           data = data.frame(week = week(as_date(c("2000-8-1", "2000-06-15"))),
                             m = -Inf,
                             end = week(as_date(c("2000-12-1", "2000-11-1"))),
                             site = c("Paracou", "Tapajos"))) +
  geom_ribbon(aes(ymin = l, ymax = h, fill = type), col = NA, alpha = 0.2) +
  geom_smooth(aes(col = type), se = FALSE) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_discrete("") +
  scale_color_discrete("") +
  facet_wrap(~ site, scales = "free_x") +
    scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) +
  ylab(expression("Leaf Area Index ["~m^2~m^{-~2}~"]")) + xlab("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sat", "obs", "sim")]), 
                     labels = c("Terrestrial", "Satellite", "Drone", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("obs", "sat", "obs", "sim")]), 
                     labels = c("Terrestrial", "Satellite", "Drone", "TROLL"))
ggsave("figures/f05.png", g, dpi = 300, width = 8, height = 5, bg = "white")
g
```

```{r laievaltab}
daily %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  gather(type, observed, -site, -date, -simulated) %>% 
  na.omit() %>% 
  nest_by(site, type) %>% 
  mutate(R2 = summary(lm(observed ~ 0 + simulated, data = data))$r.squared,
         CC = cor(data$simulated, data$observed),
         RMSEP = sqrt(mean((data$simulated-data$observed)^2)),
         RRMSEP = sqrt(mean((data$simulated-data$observed)^2))/mean(data$observed),
         SD =sd(data$simulated-data$observed),
         RSD =sd(data$simulated-data$observed)/mean(data$observed)) %>% 
  select(-data) %>% 
  knitr::kable(caption = "Evaluation fo daily means of ET at Paracou and Tapajos.")
```

### Leaf Area Index per Age

For comparisons with @yang2023, we also simulated Leaf Area Index per leaf-age class. In the figure 8 of @yang2023 Tapajos is represented by the subclass S1, characterised by an always higher values old LAI above 3 m2/m2 and lower values of young and mature LAI around 1.5 m2/m2, while Paracou is represented by the subclass S2, characterised with high values of old LAI and low value of young and mature LAI in wet season but a strong loss of old LAI, a strong increase in mature LAI, a slight increase of young LAI in dry season. Similarly, in our simulations we observed a high LAI of old leaves especially in Tapajos. It seems that old leaf area are overestimated in Tapajos, because a priori there is little interest in accumulating less efficient leaves, and therefore confirms the hypothesis that the basal flux of litter is not high enough for Tapajos. At Paracou, we simulated back the phenology of @yang2023 with increased young LAI and mature LAI in the dry season while old LAI is decreasing, but a bit later than in @yang2023 and with values of mature LAI similar to those of old LAI between 2 and 3.5 m2/m2.

```{r laiadata}
#| message: false
daily <- read_tsv("outputs/evaluation_fluxes.tsv") %>% 
  filter(variable %in% c("lai_mature", "lai_old", "lai_young")) %>% 
  separate(variable, c("variable", "age")) %>% 
  rename(value = simulated)
monthly <- daily %>% 
  group_by(site, date = floor_date(date, "month"), variable, age) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            value = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE))
cols_laid <- c("young" = "#2bd22c", "mature" = "#197b14", "old" = "#ffa006")
```

```{r laiadaily}
#| message: false
#| warning: false
#| fig-cap: "Daily and monthly means of leaf area index for Paracou and Tapajos with leaf cohorts of yound, mature and old leaves. Dark lines are the monthly means, semi-transparent lines are the daily means variations."
daily %>% 
  ggplot(aes(date, value, col = age)) +
  geom_line(alpha = 0.5) +
  geom_line(data = monthly) +
  facet_wrap(~ site, scales = "free_x") +
  theme_bw() +
  theme(legend.position = "bottom") +
  xlab("") + 
  ylab(expression("Leaf Area Index ["~m^2~m^{-2}~"]")) +
  scale_color_manual("", values = as.vector(cols_laid[c("mature", "old", "young")]))
```

```{r laia15days}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of leaf area index for Paracou and Tapajos with leaf cohorts of yound, mature and old leaves. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
g <- daily %>% 
  group_by(site, variable, age, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date)) %>%  
  group_by(site, variable, age, week) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  mutate(type = "TROLL") %>% 
  bind_rows(read_tsv("data/fluxes/lai_age.tsv") %>% 
              filter(type == "time series") %>% 
              mutate(type = "Yang et al. (2023)")) %>% 
  ggplot(aes(week, m)) +
  geom_rect(aes(xmin = week, xmax = end), fill  = "#fff4e0",
           ymin = -Inf, ymax = Inf, alpha = 0.5,
           data = data.frame(week = week(as_date(c("2000-8-1", "2000-06-15"))),
                             m = -Inf,
                             end = week(as_date(c("2000-12-1", "2000-11-1"))),
                             site = c("Paracou", "Tapajos"))) +
  geom_ribbon(aes(ymin = l, ymax = h, fill = age), col = NA, alpha = 0.2) +
  geom_smooth(aes(col = age), se = FALSE) +
  theme_bw() +
  scale_fill_discrete("") +
  scale_color_discrete("") +
  facet_grid(site~ type) +
  scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) + 
  ylab(expression("Leaf Area Index ["~m^2~m^{-~2}~"]")) + xlab("") +
  scale_color_manual("", values = as.vector(cols_laid[c("mature", "old", "young")])) +
  scale_fill_manual("", values = as.vector(cols_laid[c("mature", "old", "young")]))
ggsave("figures/fs05.png", g, dpi = 300, width = 8, height = 5, bg = "white")
g
```

### Evapotranspiration

The new version of TROLL correctly simulated the phenology of evapotranspiration (ET, mm/day), with a lower ET in wet season and an higher evaporative demand in the dry season. Simulations are slightly underestimating the ET but globally daily values overlaps in most of the 15-days windows with a wet season flux simulated around 2 mm/day against 3 mm/day observed in Paracou and both around 3.5 mm/day in the dry season. Similarly in Tapajos, the wet season flux simulated drop to almost 1 mm/day despite being above 2 mm/day in observations and they both reach 3 mm/day in the dry season. Both simulations and observations are driven by daily maximum vapour pressure deficit with a correlation coefficient between 0.58 and 0.67 for observation, and more deterministic for simulations between 0.89 and 0.93. Globally, simulated ET showed a very good evaluation with a correlation coefficient of 0.73 in Paracou and 0.72 in Tapajos against daily observations from eddy-flux towers, and corresponding RMSEP of respectively 0.9 and 0.8 mm/day.

```{r etdata}
#| message: false
daily <- read_tsv("outputs/evaluation_fluxes.tsv") %>% 
  filter(variable == "et") %>% 
  left_join(read_tsv("outputs/fluxnet_fluxes.tsv") %>% 
              mutate(observed = value*20) %>% 
              select(-value)) %>% 
  left_join(read_tsv("outputs/fluxnet_fluxes.tsv") %>% 
              filter(variable == "vpd_max") %>% 
              rename(vpdmax = value) %>% 
              select(-variable)) %>% 
  gather(type, value, -site, -date, -variable, -vpdmax)
monthly <- daily %>% 
  group_by(site, date = floor_date(date, "month"), variable, type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            value = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE))
```

```{r etdaily}
#| message: false
#| warning: false
#| fig-cap: "Daily and monthly means of evapotranpsiration for Paracou and Tapajos. Dark lines are the monthly means, semi-transparent lines are the daily means variations"
daily %>% 
  ggplot(aes(date, value, col = type)) +
  geom_line(alpha = 0.5) +
  geom_line(data = monthly) +
  facet_wrap(~ site, scales = "free_x") +
  theme_bw() +
  theme(legend.position = "bottom") +
  xlab("") + 
  ylab(expression("Evapotranspiration ["~mm~day^{-~1}~"]")) +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL"))
```

```{r et15days}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of evapotranspiration for Paracou and Tapajos. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
g <- daily %>% 
  group_by(site, variable, type, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date)) %>%  
  group_by(site, variable, type, week) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  ggplot(aes(week, m)) +
  geom_rect(aes(xmin = week, xmax = end), fill  = "#fff4e0",
           ymin = -Inf, ymax = Inf, alpha = 0.5,
           data = data.frame(week = week(as_date(c("2000-8-1", "2000-06-15"))),
                             m = -Inf,
                             end = week(as_date(c("2000-12-1", "2000-11-1"))),
                             site = c("Paracou", "Tapajos"))) +
  geom_ribbon(aes(ymin = l, ymax = h, fill = type), col = NA, alpha = 0.2) +
  geom_smooth(aes(col = type), se = FALSE) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_discrete("") +
  scale_color_discrete("") +
  facet_wrap(~ site, scales = "free_x") +
    scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) + 
  ylab(expression("Evapotranspiration ["~mm~day^{-~1}~"]")) + xlab("") +
    scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL"))
ggsave("figures/f02.png", g, dpi = 300, width = 8, height = 5, bg = "white")
g
```

```{r etvpd}
#| message: false
#| warning: false
#| fig-cap: "Daily averages of evapotranspiration as a function of daily maximum vapour pressure deficit for model- and tower-based estimates at Paracou and Tapajos."
g <- daily %>% 
  ggplot(aes(vpdmax, value, col = type)) +
  geom_point(alpha = 0.1) +
  theme_bw() +
  facet_wrap(~ site) +
  theme(legend.position = "bottom") +
  facet_wrap(~ site) +
  ylab(expression("Evapotranspiration ["~mm~day^{-~1}~"]")) + 
  xlab(expression("daily maximum Vapour Pressure deficit ["~kPa~day^{-~1}~"]")) + 
  ylim(0, NA) +
  ggpubr::stat_cor() +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL"))
ggsave("figures/f04.png", g, dpi = 300, width = 8, height = 5, bg = "white")
g
```

```{r etevalplot}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of simulated versus observed daily means of ET in Paracou and Tapajos."
daily %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  ggplot(aes(simulated ,observed, col = yday(date))) +
  facet_wrap(~ site) +
  theme_bw() +
  geom_point() +
  scale_color_viridis_c("Day") +
  geom_abline(col = "red") +
  ylab(expression("Observed ET ["~mm~day^{-~1}~"]")) + 
  xlab(expression("Simulated ET ["~mm~day^{-~1}~"]")) + 
  scale_color_viridis_c("Day") +
  ggpubr::stat_cor()
```

```{r etevaltab}
daily %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  na.omit() %>% 
  nest_by(site, variable) %>% 
  mutate(R2 = summary(lm(observed ~ 0 + simulated, data = data))$r.squared,
         CC = cor(data$simulated, data$observed),
         RMSEP = sqrt(mean((data$simulated-data$observed)^2)),
         RRMSEP = sqrt(mean((data$simulated-data$observed)^2))/mean(data$observed),
         SD =sd(data$simulated-data$observed),
         RSD =sd(data$simulated-data$observed)/mean(data$observed)) %>% 
  select(-data) %>% 
  knitr::kable(caption = "Evaluation fo daily means of ET at Paracou and Tapajos.")
```

### Relative Soil Water Content

We only had soil water content measurement for Paracou. Moreover, soil water content measurement are measured with electric measurement of conductance and rely a lot on calibration. We thus decided to use Relative Soil water Content (RSWC, %) to avoid bias of tool calibration and focus on within-year variations. The new version of TROLL correctly simulated the phenology of RSWC, with a higher RSWC in wet season around 100% with fully saturated soils and a strong drop in RSWC in the dry season. Focusing on the drop in dry seasons, the mean value simulated across year in Paracou dropped to 80% but exceptionally dry years drop up to 50%. The observed conditions are harsher with a mean observed drop around 50% across years that is below 50 most years and drop to 40% the driest years. Globally, simulated RSWC showed a good evaluation at Paracou with a correlation coefficient of 0.77 against daily observations from eddy-flux towers, and corresponding RMSEP of 23 %.

```{r rswcdata}
#| message: false
#| warning: false
daily <- read_tsv("outputs/evaluation_fluxes.tsv") %>% 
  filter(variable == "rswc10") %>% 
  left_join(read_tsv("outputs/guyaflux_swc.tsv") %>% 
              filter(variable == "swc10") %>% 
              group_by(site, year = year(date)) %>% 
              mutate(observed = value / quantile(value, 0.95, na.rm = T)) %>% 
              ungroup() %>% 
              mutate(variable = "rswc10") %>% 
              select(-year, -value)) %>% 
  gather(type, value, -site, -date, -variable) %>% 
  na.omit()
monthly <- daily %>% 
  group_by(site, date = floor_date(date, "month"), variable, type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            value = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE))
```

```{r rswcdaily}
#| message: false
#| warning: false
#| fig-cap: "Daily and monthly means of relative soil water content for Paracou and Tapajos. Dark lines are the monthly means, semi-transparent lines are the daily means variations."
daily %>% 
  ggplot(aes(date, value, col = type)) +
  geom_line(alpha = 0.5) +
  geom_line(data = monthly) +
  facet_wrap(~ site, scales = "free_x") +
  theme_bw() +
  theme(legend.position = "bottom") +
  xlab("") + 
  ylab(expression("Relative Soil Water Content ["~"%"~"]")) +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL"))
```

```{r rswc15days}
#| message: false
#| warning: false
#| fig-cap: "Mean annual cycle from fortnightly means of relative soil water content for Paracou and Tapajos. Bands are the intervals of means across years, and rectangles in the background correspond to the site's climatological dry season."
g <- daily %>% 
  group_by(site, variable, type, date = floor_date(date, "15 days")) %>% 
  summarise_all(mean, na.rm = T) %>%
  mutate(week = week(date)) %>%  
  group_by(site, variable, type, week) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = mean(value, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  ggplot(aes(week, m)) +
  geom_rect(aes(xmin = week, xmax = end), fill  = "#fff4e0",
           ymin = -Inf, ymax = Inf, alpha = 0.5,
           data = data.frame(week = week(as_date(c("2000-8-1", "2000-06-15"))),
                             m = -Inf,
                             end = week(as_date(c("2000-12-1", "2000-11-1"))),
                             site = c("Paracou", "Tapajos"))) +
  geom_ribbon(aes(ymin = l, ymax = h, fill = type), col = NA, alpha = 0.2) +
  geom_smooth(aes(col = type), se = FALSE) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_discrete("") +
  scale_color_discrete("") +
  facet_wrap(~ site, scales = "free_x") +
    scale_x_continuous(breaks = week(as_date(paste("2000-", 1:12, "-01"))),
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) + 
  ylab(expression("Relative Soil Water Content ["~"%"~"]")) + xlab("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL")) +
  scale_fill_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Tower", "TROLL"))
ggsave("figures/fs04.png", g, dpi = 300, width = 8, height = 5, bg = "white")
g
```

```{r rswcevaltab}
daily %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  na.omit() %>% 
  nest_by(site, variable) %>% 
  mutate(R2 = summary(lm(observed ~ 0 + simulated, data = data))$r.squared,
         CC = cor(data$simulated, data$observed),
         RMSEP = sqrt(mean((data$simulated-data$observed)^2)),
         RRMSEP = sqrt(mean((data$simulated-data$observed)^2))/mean(data$observed),
         SD =sd(data$simulated-data$observed),
         RSD =sd(data$simulated-data$observed)/mean(data$observed)) %>% 
  select(-data) %>% 
  knitr::kable(caption = "Evaluation fo daily means of RSWC at Paracou and Tapajos.")
```

## Structure

The main development of TROLL version 4 is the inclusion of a new explicit modelling of daily water and carbon fluxes as well as a new leaf phenology. We thus focused TROLL version 4 evaluation on fluxes, as forest structure and composition was extensively assessed in @maréchaux2017 . However here, we quickly investigate back forest structure and composition in Paracou and Tapajos.

```{r simforestdata}
#| eval: false
files <- list.files("results/run3/", pattern = "final_pattern.txt", 
                    recursive = T, full.names = T) 
names(files) <- list.files("results/run3/", pattern = "final_pattern.txt", 
                    recursive = T, full.names = F) 
troll_forest <- files %>% 
  lapply(vroom::vroom) %>% 
  bind_rows(.id = "file") %>% 
  separate(file, "sim", "/") %>% 
  separate(sim, c("site", "repetition")) %>%
  mutate(repetition = as.numeric(gsub("R", "", repetition))) %>% 
  mutate(species = gsub("_", " ", s_name)) %>% 
  mutate(dbh = dbh*100)
write_tsv(troll_forest, "outputs/evaluation_forest.tsv")
```

### Forest

We characterized global forests structure through their distribution of basal area (m2/ha) and logged abundance per 10-cm classes of diameter at breast height (DBH, cm) for trees above 10 cm DBH. We found simulated back the same distributions in Paracou with a small lack of smaller diameters and slight increase in trees with a diameter around 100 cm. But beware of stochasticity that may have resulted in a few big trees surviving in the 16-ha simulations. We found back in Paracou a total basal area of 29 m2/ha against a mean observed of 30 across plots and a total number of 576 individuals simulated per hectare against a mean observed of 655 across plots. In Tapajos, we found very similar distribution but with increased small diameters in simulation and a lack of big trees (above 100cm). We thus overestimated basal area (30 m2/ha against 24 observed) and abundance (598 against 632 observed). However, Tapajos data are based on only 8 very small plots of 0.25ha, which may have resulted in an over-representation of a few big individuals. The resulting quantiles comparisons are very good with a correlation coefficient above 0.93 for all metrics and sites except Tapajos were basal area correlation coefficient was only 0.72.

```{r str}
#| message: false
structure <- read_tsv("outputs/evaluation_forest.tsv") %>% 
  filter(dbh >= 10) %>% 
  mutate(plot = repetition) %>% 
  select(site, plot, dbh) %>% 
  mutate(dbh_class = cut(dbh, breaks = seq(10, 200, by = 10), 
                         labels = seq(10, 190, by = 10)+5)) %>% 
  mutate(dbh_class = as.numeric(as.character(dbh_class))) %>% 
  group_by(site, plot, dbh_class) %>% 
  summarise(abundance = n()/4,
            ba = sum((dbh/2)^2*pi)/10^4/4) %>% 
  mutate(log_abundance = log10(abundance)) %>% 
  gather(variable, simulated, -site, -dbh_class, -plot) %>% 
  full_join(read_tsv("outputs/structure.tsv") %>% 
              filter(type != "understory") %>% 
              select(-type)) %>% 
  gather(type, value, -site, -dbh_class, -variable, -plot) %>% 
  group_by(site, dbh_class, variable, type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = quantile(value, 0.5, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  na.omit() %>% 
  mutate(varlong = recode(variable, "ba" = 'Basal~area~"["~m^{2}~m^{-~2}~"]"',
                          "log_abundance" = 'Log[10]~abundance~"["~ha^{-~1}~"]"'))
```

```{r dbhstr}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of the size structure estimated by TROLL at the Paracou and Tapajos sites, expressed in terms of abundance and basal area. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
labs <- structure %>% 
  filter(variable %in% c("ba", "log_abundance")) %>% 
  mutate(m = ifelse(variable == "log_abundance", 10^m, m)) %>% 
  group_by(variable, varlong, type, site) %>% 
  summarise(total = sum(m)) %>% 
  group_by(variable, site) %>% 
  pivot_wider(names_from = type, values_from = total) %>% 
  mutate(label = paste0("Field: ", round(observed), "\nTROLL: ", round(simulated))) %>% 
  mutate(dbh_class = 120) %>% 
  mutate(m = ifelse(variable == "log_abundance", 1.5, 5)) 
filter(structure, variable %in% c("ba", "log_abundance")) %>% 
  ggplot(aes(dbh_class, m)) +
  geom_linerange(aes(ymin = l, ymax = h, col = type)) +
  geom_point(aes(col = type)) +
  geom_line(aes(col = type)) +
  theme_bw() +
  facet_grid(varlong ~ site, scales = "free_y", labeller = label_parsed) +
  xlab("DBH [ cm ]") + ylab("") +
  scale_color_discrete("") +
  theme(legend.position = "bottom") +
  geom_text(data = labs, aes(label = label)) +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
```

```{r dbhstreval}
#| message: false
#| warning: false
#| fig-cap: "Quantiles comparisons of the size structure estimated by TROLL at the Paracou and Tapajos sites, expressed in terms of abundance and basal area. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
structure %>% 
  filter(variable != "abundance") %>% 
  gather(quantile, value, -site, -dbh_class, -variable, -varlong, -type) %>% 
  mutate(type = str_sub(type, 1, 3)) %>% 
  mutate(quantile = paste0(quantile, "_", type)) %>% 
  select(-type) %>% 
  pivot_wider(names_from = quantile, values_from = value) %>% 
  ggplot(aes(m_obs, m_sim, col = dbh_class)) +
  geom_linerange(aes(ymin = l_sim, ymax = h_sim)) +
  geom_linerange(aes(xmin = l_obs, xmax = h_obs)) +
  geom_point() +
  facet_wrap(~ site ~ varlong, scales = "free", labeller = label_parsed) +
  theme_bw() +
  geom_abline() +
  ylab("Simulated") + xlab("Observed") +
  scale_color_viridis_c(guide = "none") +
  ggpubr::stat_cor() 
```

### Understory

Taking advantage of new inventories of understory in Paracou, we assessed TROLL version 4 ability to simulate understory. We found TROLL to understimate the number of small trees with DBH close to 1cm and overestimate bigger trees with DBH closer to 10. We ewpected this behaviour as TROLL only simulates one tree per square meter. Nonetheless we found back a basal area of 4 m2/ha despite an underestimation of 2,310 individuals per hectare against 3,787, observed.

```{r understory}
#| message: false
understory <- read_tsv("outputs/evaluation_forest.tsv") %>% 
  filter(dbh <= 10) %>% 
  mutate(plot = repetition) %>% 
  select(site, plot, dbh) %>% 
  mutate(dbh_class = cut(dbh, breaks = seq(1, 10, by = 1), 
                         labels = seq(1, 9, by = 1)+0.5)) %>% 
  mutate(dbh_class = as.numeric(as.character(dbh_class))) %>% 
  group_by(site, plot, dbh_class) %>% 
  summarise(abundance = n()/4,
            ba = sum((dbh/2)^2*pi)/10^4/4) %>% 
  mutate(log_abundance = log10(abundance)) %>% 
  gather(variable, simulated, -site, -dbh_class, -plot) %>% 
  full_join(read_tsv("outputs/structure.tsv") %>% 
            filter(type == "understory") %>% 
              select(-type)) %>% 
  gather(type, value, -site, -dbh_class, -variable, -plot) %>% 
  group_by(site, dbh_class, variable, type) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = quantile(value, 0.5, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  na.omit() %>% 
  mutate(varlong = recode(variable, "ba" = 'Basal~area~"["~m^{2}~m^{-~2}~"]"',
                          "log_abundance" = 'Log[10]~abundance~"["~ha^{-~1}~"]"'))
```

```{r understoryfig}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of the size structure estimated by TROLL at the Paracou site with understorey trees, expressed in terms of abundance and basal area. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
labs <- structure %>% 
  filter(variable %in% c("ba", "log_abundance")) %>% 
  mutate(m = ifelse(variable == "log_abundance", 10^m, m)) %>% 
  group_by(variable, varlong, type, site) %>% 
  summarise(total = sum(m)) %>% 
  group_by(variable, site) %>% 
  pivot_wider(names_from = type, values_from = total) %>% 
  mutate(label = paste0("Field: ", round(observed), "\nTROLL: ", round(simulated))) %>% 
  mutate(dbh_class = 5) %>% 
  mutate(m = ifelse(variable == "log_abundance", 3, 0.6)) 
filter(understory, variable %in% c("ba", "log_abundance")) %>% 
  ggplot(aes(dbh_class, m)) +
  geom_linerange(aes(ymin = l, ymax = h, col = type)) +
  geom_point(aes(col = type)) +
  geom_line(aes(col = type)) +
  theme_bw() +
  facet_grid(varlong ~ site, scales = "free_y", labeller = label_parsed) +
  xlab("DBH [ cm ]") + ylab("") +
  scale_color_discrete("") +
  theme(legend.position = "bottom") +
  geom_text(data = labs, aes(label = label)) +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
```

```{r understoryeval}
#| message: false
#| warning: false
#| fig-cap: "Quantiles comparisons of the size structure estimated by TROLL at the Paracou with understory trees, expressed in terms of abundance and basal area. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
understory %>% 
  filter(site == "Paracou") %>% 
  filter(variable != "abundance") %>% 
  gather(quantile, value, -site, -dbh_class, -variable, -varlong, -type) %>% 
  mutate(type = str_sub(type, 1, 3)) %>% 
  mutate(quantile = paste0(quantile, "_", type)) %>% 
  select(-type) %>% 
  pivot_wider(names_from = quantile, values_from = value) %>% 
  ggplot(aes(m_obs, m_sim, col = dbh_class)) +
  geom_linerange(aes(ymin = l_sim, ymax = h_sim)) +
  geom_linerange(aes(xmin = l_obs, xmax = h_obs)) +
  geom_point() +
  facet_wrap(~ varlong, scales = "free", labeller = label_parsed) +
  theme_bw() +
  geom_abline() +
  ylab("Simulated") + xlab("Observed") +
  scale_color_viridis_c(guide = "none") +
  ggpubr::stat_cor() +
  ggtitle("Paracou")
```

### All

```{r allstr}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of the size structure estimated by TROLL at the Paracou and Tapajos sites, expressed in terms of abundance and basal area and including understorey trees at Paracou. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
all_str <- bind_rows(
  mutate(understory, site = '"Paracou "<= "10 cm"'),
  mutate(structure, site = ifelse(site == "Paracou", '"Paracou ">= "10 cm"', '"Tapajos ">= "10 cm"'))
  ) %>% filter(variable %in% c("ba", "log_abundance"))
labs <- all_str %>% 
  filter(variable %in% c("ba", "log_abundance")) %>% 
  mutate(m = ifelse(variable == "log_abundance", 10^m, m)) %>% 
  group_by(variable, varlong, type, site) %>% 
  summarise(total = sum(m)) %>% 
  group_by(variable, site) %>% 
  pivot_wider(names_from = type, values_from = total) %>% 
  mutate(label = paste0("Field: ", round(observed), "\nTROLL: ", round(simulated))) %>% 
  ungroup() %>% 
  mutate(dbh_class = c(8, 120, 120, 8, 120, 120)) %>% 
  mutate(m = c(0.2, 7, 5, 3, 2, 2))
g <- all_str %>% 
  ggplot(aes(dbh_class, m)) +
  geom_linerange(aes(ymin = l, ymax = h, col = type)) +
  geom_point(aes(col = type)) +
  geom_line(aes(col = type)) +
  theme_bw() +
  facet_wrap(varlong ~ site, scales = "free", labeller = label_parsed) +
  xlab("DBH [ cm ]") + ylab("") +
  scale_color_discrete("") +
  theme(legend.position = "bottom") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL")) +
  geom_text(data = labs, aes(label = label))
ggsave("figures/f06.png", g, dpi = 300, width = 8, height = 5, bg = "white")
g
```

## Composition

### Species

Observed species rank-abundance curves in Paracou and Tapajos revealed low evenness with a few dominating species even more intense in Tapajos. However, Tapajos data are based on only 8 very small plots of 0.25ha, which may not be representative despite their virtual pooling in two 1-ha plots, and the quality of the species identifications can be lower. Simulated rank-abundance curve in Paracou was similar to the observed one with a correlation coefficient of 0.95 but with higher evenness resulting in underestimation of dominant species abundances and overestimation of rare species abundances. Simulated rank-abundance curve in Tapajos was very similar to the one simulated in Paracou but differed a lot of the one in Tapajos with strong underestimation of dominant species abundances and overestimation of rare species abundances. But once again observation data in Tapajos might be question for species resolution.

```{r compodata}
#| message: false
#| warning: false
compositon <- read_tsv("outputs/evaluation_forest.tsv") %>% 
  filter(dbh >= 10) %>% 
  mutate(plot = repetition) %>% 
  mutate(species = gsub("_", " ", s_name)) %>% 
  select(site, plot, species) %>% 
  group_by(site, plot, species) %>% 
  summarise(simulated = n()/4) %>% 
  mutate(variable = "abundance") %>% 
  select(site, plot, species, variable, simulated) %>% 
  full_join(read_tsv("outputs/composition.tsv")) %>% 
  gather(type, value, -site, -plot, -variable, -species) %>% 
  group_by(site, plot, variable, type) %>% 
  arrange(desc(value)) %>% 
  mutate(rank = 1:n()) %>% 
  group_by(site, rank, type, variable) %>% 
  summarise(l = quantile(value, 0.025, na.rm = TRUE), 
            m = quantile(value, 0.5, na.rm = TRUE), 
            h = quantile(value, 0.975, na.rm = TRUE)) %>% 
  filter(rank < 115)
```

```{r compofig}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of the species composition estimated by TROLL at the Paracou and Tapajos sites expressed in terms of species rank-abundance curve. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
g <- compositon %>% 
  ggplot(aes(rank, m, col = type)) +
  geom_line(aes(y = l), linewidth = 0.5, linetype = "dashed") +
  geom_line(aes(y = h), linewidth = 0.5, linetype = "dashed") +
  geom_line() +
  theme_bw() +
  facet_wrap(~ site) +
  xlab("Rank") + ylab(expression(Abundance~"["~ha^{-~1}~"]")) +
  scale_color_discrete("") +
  theme(legend.position = "bottom") +
  scale_y_log10()  +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
ggsave("figures/f07.png", g, dpi = 300, width = 8, height = 5, bg = "white")
g
```

```{r compoquant}
#| message: false
#| warning: false
#| fig-cap: "Quantiles comparisons of the species composition estimated by TROLL at the Paracou and Tapajos sites expressed in terms of species rank-abundance curve. Confidence intervals on inventory analysis at 95 % are shown with error bars and are based on among plots variations. The confidence on the TROLL values was estimated generating an ensemble of 10 simulations (see methods)."
compositon %>% 
  ungroup() %>% 
  gather(quantile, value, -site, -rank, -variable, -type) %>% 
  mutate(type = str_sub(type, 1, 3)) %>% 
  mutate(quantile = paste0(quantile, "_", type)) %>% 
  select(-type) %>% 
  pivot_wider(names_from = quantile, values_from = value) %>% 
  ggplot(aes(m_obs, m_sim, col = rank)) +
  geom_linerange(aes(ymin = l_sim, ymax = h_sim)) +
  geom_linerange(aes(xmin = l_obs, xmax = h_obs)) +
  geom_point() +
  facet_wrap(~ site, scales = "free") +
  theme_bw() +
  geom_abline() +
  ylab(expression("Simulated abundance ["~ha^{-~1}~"]")) +
  xlab(expression("Observed abundance ["~ha^{-~1}~"]")) +
  scale_y_log10() + scale_x_log10() +
  scale_color_viridis_c(guide = "none") +
  ggpubr::stat_cor()
```

### Functional

Simulated functional trait distribution in Paracou and Tapajos matched the ones observed with quantiles correlations above 0.9 for all traits and sites, at th exception of leaf area in Paracou. However due to a poor species resolution in Tapajos we used mean genus values, which may result in an overestimation of assessment in Tapajos. Leaf area differences in Paracou come to the lack of very high leaf area species in the simulations compared to the Paracou plots, however the resulting correlation coefficient might have differed if we would have used log-transformed leaf area). Diving into the observed data, the high leaf area values are due to pioneer species including *Cecropia obtusa* and *sciadophylla*, *Sterculia speciosa* and *Perebea guianensis*. The three genus are present in the simulations inputs, but seems to lack in the final forest due to either a lack of forest gaps or a lack of survival.

```{r ftdata}
#| message: false
#| warning: false
troll_traits <- list(
    read_tsv("outputs/paracou_species_troll.tsv"),
    read_tsv("outputs/tapajos_species_troll.tsv")
) %>% bind_rows() %>% 
  unique() %>% 
  rename_all(~ gsub("s_", "", .)) %>% 
  select(-seedmass, -regionalfreq) %>% 
  rename(species = name) %>% 
  mutate(species = gsub("_", " ", species)) %>% 
  gather(trait, trait_value, -species)
troll_traitdist <- read_tsv("outputs/evaluation_forest.tsv") %>% 
  filter(dbh >= 10) %>% 
  mutate(plot = repetition) %>% 
  select(site, plot, species) %>% 
  left_join(troll_traits)
all_traits_q <- bind_rows(
  mutate(troll_traitdist, type = "sim"),
  mutate(read_tsv("outputs/functional_composition.tsv"), type = "obs")
) %>% 
  group_by(site, trait, plot, type) %>% 
  summarise(quantile = list(quantile(trait_value, seq(0, 1, length.out = 100)))) %>% 
  unnest_longer(quantile) %>% 
  group_by(site, trait, type, quantile_id)%>% 
  summarise(l = quantile(quantile, 0.025, na.rm = TRUE), 
            m = quantile(quantile, 0.5, na.rm = TRUE), 
            h = quantile(quantile, 0.975, na.rm = TRUE)) %>% 
  gather(quantile, value, -site, -trait, -type, -quantile_id) %>% 
  mutate(quantile = paste0(quantile, "_", type)) %>% 
  ungroup() %>% 
  select(-type) %>% 
  pivot_wider(names_from = quantile, values_from = value)
```

```{r ftparfig}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of the functional composition estimated by TROLL at the Paracou site expressed in terms of density distribution per trait and site. The analyses have been done at the species level in Paracou."
read_tsv("outputs/functional_composition.tsv") %>% 
  filter(site == "Paracou") %>% 
  ggplot(aes(trait_value, group = plot)) +
  geom_density(aes(col = "Observed")) +
  geom_density(aes(col = "Simulated"),
               data = filter(troll_traitdist, site == "Paracou")) +
  facet_wrap(~ trait, scales = "free") +
  theme_bw() +
  ggtitle("Paracou", "546,498 inds represented on 577,761 (94.59%)") +
  theme(axis.title = element_blank(), legend.position = "bottom") +
  scale_color_discrete("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
```

```{r ftparquant}
#| message: false
#| warning: false
#| fig-cap: "Quantiles comparisons of the functional composition estimated by TROLL at the Paracou site expressed in terms of density distribution per trait and site. The analyses have been done at the species level in Paracou."
all_traits_q %>% 
  filter(site == "Paracou") %>% 
  ggplot(aes(m_obs, m_sim)) +
  geom_abline(col = "blue") +
  geom_linerange(aes(ymin = l_sim, ymax = h_sim), alpha = .5) +
  geom_linerange(aes(xmin = l_obs, xmax = h_obs), alpha = .5) +
  geom_point() +
  theme_bw() +
  facet_wrap(~ trait, scales = "free") +
  ggtitle("Paracou", "546,498 inds represented on 577,761 (94.59%)") +
  xlab("Observed trait quantiles") +
  ylab("Simulated trait quantiles") +
  ggpubr::stat_cor()
```

```{r fttapfig}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of the functional composition estimated by TROLL at the Tapajos site expressed in terms of density distribution per trait and site. The analyses have been done at the genus level in Tapajos."
read_tsv("outputs/functional_composition.tsv") %>% 
  filter(site == "Tapajos") %>% 
  ggplot(aes(trait_value, group = plot)) +
  geom_density(aes(col = "Observed")) +
  geom_density(aes(col = "Simulated"),
               data = filter(troll_traitdist, site == "Tapajos")) +
  facet_wrap(~ trait, scales = "free") +
  theme_bw() +
  ggtitle("Tapajos Genus level", "19,188 inds represented on 19,499 (98.65%)") +
  theme(axis.title = element_blank(), legend.position = "bottom") +
  scale_color_discrete("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
```

```{r ftaptquant}
#| message: false
#| warning: false
#| fig-cap: "Quantiles comparisons of the functional composition estimated by TROLL at the Tapajos site expressed in terms of density distribution per trait and site. The analyses have been done at the genus level in Tapajos."
all_traits_q %>% 
  filter(site == "Tapajos") %>% 
  ggplot(aes(m_obs, m_sim)) +
  geom_abline(col = "blue") +
  geom_linerange(aes(ymin = l_sim, ymax = h_sim), alpha = .5) +
  geom_linerange(aes(xmin = l_obs, xmax = h_obs), alpha = .5) +
  geom_point() +
  theme_bw() +
  facet_wrap(~ trait, scales = "free") +
  ggtitle("Tapajos Genus level", "19,188 inds represented on 19,499 (98.65%)") +
  xlab("Observed trait quantiles") +
  ylab("Simulated trait quantiles") +
  ggpubr::stat_cor() + 
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
```

```{r ftallfig}
#| message: false
#| warning: false
#| fig-cap: "Evaluation of the functional composition estimated by TROLL at the Paracou and Tapajos sites expressed in terms of density distribution per trait and site. The analyses have been done at the species level in Paracou and the genus level in Tapajos."
g <- read_tsv("outputs/functional_composition.tsv") %>%
  mutate(trait_long = recode(trait, "ah" = "a[h]", "dbhmax" = "dbh[max]", "hmax" = "h[lim]",
                             "leafaera" = "LA", "Nmass" = "N[mass]", "Pmass" = "P[mass]",
                             "tlp" = "psi[tlp]", "wsg" = "WSG")) %>% 
  mutate(varlong = paste0('"', site, ':"~', trait_long)) %>% 
  ggplot(aes(trait_value, group = plot)) +
  geom_density(aes(col = "Observed")) +
  geom_density(aes(col = "Simulated"), 
               data = troll_traitdist %>% 
                   mutate(trait_long = recode(trait, "ah" = "a[h]", "dbhmax" = "dbh[max]",
                                              "hmax" = "h[lim]",
                             "leafaera" = "LA", "Nmass" = "N[mass]", "Pmass" = "P[mass]",
                             "tlp" = "psi[tlp]", "wsg" = "WSG")) %>% 
  mutate(varlong = paste0('"', site, ':"~', trait_long))) +
  facet_wrap(~ varlong, scales = "free", labeller = label_parsed) +
  theme_bw() +
  theme(axis.title = element_blank(), legend.position = c(0.8, 0.1)) +
  scale_color_discrete("") +
  scale_color_manual("", values = as.vector(cols[c("obs", "sim")]), 
                     labels = c("Field", "TROLL"))
ggsave("figures/f08.png", g, dpi = 300, width = 8, height = 5, bg = "white")
g
```
